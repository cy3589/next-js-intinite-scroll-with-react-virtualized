import type {
  //  GetServerSideProps,
  NextPage,
} from 'next';
import Head from 'next/head';
import {
  //  QueryClient,
  useInfiniteQuery,
} from 'react-query';
// import { dehydrate } from 'react-query/hydration';
import axios from 'axios';
import {
  InfiniteLoader,
  AutoSizer,
  List,
  // OnScrollParams,
  WindowScroller,
  // ScrollParams,
  CellMeasurer,
  CellMeasurerCache,
} from 'react-virtualized';
import React, { CSSProperties, Suspense, useEffect, useRef } from 'react';
import Image from 'next/image';

const Row = React.memo(
  ({
    index,
    style,
    data,
  }: {
    index: number;
    style: CSSProperties;
    data: { name: string; url: string };
  }) => {
    return (
      <div key={index} style={style}>
        <div>{index}번째 포켓몬</div>
        <div>{data.name}</div>
        <Image src={data.url} alt={data.url} height={100} width={100} />
      </div>
    );
  },
);
Row.displayName = 'Row';

const getPokes = async ({ pageParam = 0 }) => {
  const { data: dataArr } = await axios.get(
    `https://pokeapi.co/api/v2/pokemon?limit=20&offset=${pageParam}`,
  );
  const newResults = await Promise.all(
    dataArr.results.map(
      async ({ name, url }: { name: string; url: string }) => {
        const { data: detail } = await axios.get(url);
        return { name, url: detail.sprites.front_default };
      },
    ),
  );
  return { ...dataArr, results: newResults };
};

const Poke: NextPage = () => {
  const cache = useRef(
    new CellMeasurerCache({
      fixedWidth: true,
    }),
  );
  const { data, fetchNextPage } = useInfiniteQuery('poke', getPokes, {
    getNextPageParam: (lastPage) => {
      return new URLSearchParams(
        lastPage.next.split('?')[lastPage.next.split('?').length - 1],
      ).get('offset');
    },
    enabled: typeof window !== 'undefined',
  });
  const render = data?.pages.flatMap(({ results }) => results);
  useEffect(() => {
    if (render && !(render?.length < 20)) cache.current.clearAll();
  }, [render]);
  if (typeof window === 'undefined') return null;
  return (
    <div>
      <Head>
        <title>Infinite Scroll with React-Query</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      {typeof window !== 'undefined' && (
        <InfiniteLoader
          isRowLoaded={({ index }) => (render ? index < render?.length : true)}
          rowCount={Infinity}
          loadMoreRows={async () => {
            if (data && Array.isArray(data?.pages))
              await fetchNextPage(data.pages[data.pages.length - 1]);
          }}
        >
          {({ onRowsRendered, registerChild }) => (
            <WindowScroller>
              {/* {({ isScrolling, height, scrollTop, width }) => { */}
              {({ isScrolling, height, scrollTop }) => {
                // console.log(height);
                return (
                  <AutoSizer disableHeight>
                    {({ width }) => (
                      <List
                        onRowsRendered={onRowsRendered}
                        ref={registerChild}
                        height={height}
                        autoHeight
                        width={width}
                        rowHeight={cache.current.rowHeight}
                        rowCount={render?.length || 10}
                        // onScroll={handleScroll}
                        overscanRowCount={10}
                        scrollTop={scrollTop}
                        isScrolling={isScrolling}
                        // eslint-disable-next-line react/no-unstable-nested-components
                        rowRenderer={({ key, index, style, parent }) => (
                          <CellMeasurer
                            key={key}
                            cache={cache.current}
                            parent={parent}
                            columnIndex={0}
                            rowIndex={index}
                          >
                            {render ? (
                              <Row
                                index={index}
                                style={style}
                                data={render[index]}
                              />
                            ) : null}
                          </CellMeasurer>
                        )}
                      />
                    )}
                  </AutoSizer>
                );
              }}
            </WindowScroller>
          )}
        </InfiniteLoader>
      )}
    </div>
  );
};
const PokeWrapperSuspense = () => {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <Poke />
    </Suspense>
  );
};
export default React.memo(PokeWrapperSuspense);
